# ğŸ“main topic : ORM/JPAì˜ n+1ë¬¸ì œì™€ í•´ê²°ë°©ë²•ì— ëŒ€í•´ ì„¤ëª…í•˜ì‹œì˜¤

## N+1 ë¬¸ì œë€?
ì—°ê´€ ê´€ê³„ì—ì„œ ë°œìƒí•˜ëŠ” ì´ìŠˆë¡œ ì—°ê´€ ê´€ê³„ê°€ ì„¤ì •ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ê²½ìš°ì— ì¡°íšŒëœ ë°ì´í„° ê°¯ìˆ˜(n) ë§Œí¼ ì—°ê´€ê´€ê³„ì˜ ì¡°íšŒ ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ë°œìƒí•˜ì—¬ ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ê²Œ ëœë‹¤. ì´ë¥¼ N+1 ë¬¸ì œë¼ê³  í•œë‹¤. 

> Fetch Type - Eager, Lazy
> 
> ì—°ê´€ê´€ê³„ë¡œ ì„¤ì •ëœ ì—”í‹°í‹°ì˜ ì¡°íšŒ ì‹œì ì„ ì–¸ì œë¡œ ì¡ëƒë§ˆëƒë¥¼ ì„ íƒí•˜ëŠ” ì˜µì…˜ìœ¼ë¡œ 
> N+1 ë¬¸ì œì˜ í•´ê²°ë°©ì•ˆì€ ì•„ë‹ˆë‹¤. EagerëŠ” ì—”í‹°í‹° ì¡°íšŒì‹œ ì—°ê´€ê´€ê³„ì˜ ì—”í‹°í‹°ë¥¼ ì¦‰ì‹œ
> ì¶”ê°€ ì¿¼ë¦¬ë¬¸ìœ¼ë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì˜¬ë¦¬ê³ , LazyëŠ” í”„ë¡ì‹œë¡œ ì—°ê´€ê´€ê³„ ì—”í‹°í‹°ë¥¼ ì£¼ì…í•œ í›„,
> ì—°ê´€ê´€ê³„ì˜ ì—”í‹°í‹° í˜¸ì¶œì‹œ ì‹¤ì œ ì¿¼ë¦¬ë¬¸ì´ ë‚˜ê°€ê²Œ ëœë‹¤.

## N+1 í•´ê²°ë°©ì•ˆ
### 1. Fetch join
```java
@Query("select o from Owner o join fetch o.cats")
List<Owner> findAllJoinFetch();
```

ì—°ê´€ê´€ê³„ ìˆëŠ” ì—”í‹°í‹°ë¥¼ `fetch join`í•˜ì—¬ ì˜ì†í™” ì‹œí‚¤ëŠ” ë°©ë²•.
ì‹¤ì œ SQLì€ `InnerJoin`ì„ ì‚¬ìš©í•˜ì—¬ ê²°ê³¼ë¥¼ ì¡°íšŒí•œë‹¤.

ì£¼ì˜í•  ê²ƒì€
ì¹´í…Œì‹œì•ˆ ê³±(Cartesian Product)ì´ ë°œìƒí•˜ì—¬ ì¤‘ë³µì´ ë°œìƒí•œë‹¤ëŠ” ì ì´ë¯€ë¡œ,
distinctë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, ìë£Œí˜•ì„ `Set`ìœ¼ë¡œ ê´€ë¦¬í•´ì•¼í•œë‹¤.

> ê°€ì¥ ê·¼ë³¸ì ì¸ í•´ê²°ë°©ë²•ì´ì§€ë§Œ, ê·¸ë ‡ë‹¤ê³  í•´ì„œ ë¬´ë¶„ë³„í•œ ì‚¬ìš©ì€ ìì œí•´ì•¼í•œë‹¤.
> ì—°ê´€ê´€ê³„ ì—”í‹°í‹°ë¥¼ ì‹¤ì œë¡œ ë‹¤ë£¨ëŠ” ê²½ìš°ë§Œ ì‚¬ìš©í•´ì•¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë¬´ì˜ë¯¸í•œ ì—”í‹°í‹°ë“¤ì´
> ì¡´ì¬í•˜ê²Œ ë˜ëŠ” ê²ƒì„ ë°©ì§€í•  ìˆ˜ ìˆë‹¤.

### 2. Entity Graph
```java
@EntityGraph(attributePaths = "cats")
@Query("select o from Owner o")
List<Owner> findAllEntityGraph();
```
`join fetch`ê°€ inner joinì„ ì‚¬ìš©í•œë‹¤ë©´, `Entity Graph`ëŠ” outer joinì„ ì‚¬ìš©í•œë‹¤.


### 3. Batch Size   
ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ë•Œ ì§€ì •ëœ size ë§Œí¼ SQLì˜ INì ˆì„ ì‚¬ìš©í•´ì„œ ì¡°íšŒí•œë‹¤.

Fetch joinì´ í•œë²ˆì˜ ì¡°íšŒ ì¿¼ë¦¬ë¬¸ìœ¼ë¡œ ì—°ê´€ê´€ê³„ì— ìˆëŠ” ì—”í‹°í‹°ê¹Œì§€ ì¡°íšŒ í–ˆë‹¤ë©´
í•œë²ˆì˜ ì¡°íšŒ ì¿¼ë¦¬ë¬¸ì„ ë” í•„ìš”ë¥¼ í•œë‹¤. ì´ë•Œ, ê¸°ì¡´ì˜ ì¡°íšŒ í•˜ê³ ì í•˜ëŠ”
ì—”í‹°í‹°ë¥¼ inì ˆì— ë„£ëŠ”ë°, sizeë¥¼ ì ì ˆí•˜ê²Œ ì„ íƒí•˜ì—¬ ì§€ì •í•´ì•¼í•œë‹¤.

í•˜ì§€ë§Œ, ìµœì ì˜ sizeë¥¼ ì°¾ëŠ”ê²ƒì´ ì–´ë ¤ìš´ì¼ì´ë¯€ë¡œ ê³¼ë„í•œ ì‚¬ìš©ì„ ì§€ì–‘í•´ì•¼í•œë‹¤.

> ì»¬ë ‰ì…˜ ì—°ê´€ê´€ê³„ í•„ë“œì— fetch joinì€ í•œë²ˆ ë°–ì— ì‚¬ìš©í•  ìˆ˜ì—†ë‹¤.
> ì´ë•Œ batch sizeê°€ ìœ ìš©í•˜ê²Œ ì‚¬ìš©ë  ìˆ˜ìˆë‹¤.




